<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeLink Pro - Personalized Dashboard</title>
    <style>
        :root { --brand: #d9534f; --success: #28a745; --dark: #2c3e50; --bg: #f4f7f6; --accent: #f39c12; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .app-container { max-width: 500px; margin: auto; background: white; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); min-height: 90vh; display: flex; flex-direction: column; overflow: hidden; }
        .header { background: var(--dark); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .nav-bar { display: flex; background: #34495e; }
        .nav-item { flex: 1; padding: 15px; color: #a0aec0; text-align: center; cursor: pointer; font-size: 13px; font-weight: bold; }
        .nav-item.active { color: white; border-bottom: 4px solid var(--brand); background: rgba(255,255,255,0.05); }
        .pane { padding: 25px; overflow-y: auto; flex-grow: 1; display: none; animation: fadeIn 0.4s; }
        .pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 14px; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; font-size: 15px; }
        .btn:disabled { background: #ccc !important; cursor: not-allowed; }
        
        .header-profile { width: 35px; height: 35px; border-radius: 50%; background: #444; overflow: hidden; border: 2px solid var(--brand); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .header-profile img { width: 100%; height: 100%; object-fit: cover; }

        .chart-container { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-bottom: 20px; border: 1px solid #f0f0f0; }
        .bar-wrapper { display: flex; align-items: flex-end; height: 120px; gap: 8px; justify-content: space-around; padding-top: 30px; }
        .bar { width: 24px; background: linear-gradient(to top, var(--brand), #ff7675); border-radius: 8px 8px 4px 4px; position: relative; transition: height 0.5s ease-out; }
        .bar span { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); font-size: 11px; font-weight: 900; color: var(--dark); }
        .bar-label { font-size: 9px; text-align: center; margin-top: 8px; font-weight: bold; color: #7f8c8d; }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 15px; border-radius: 18px; text-align: center; font-size: 12px; }
        .stat-card b { font-size: 22px; display: block; margin-top: 5px; }

        .card { border: 1px solid #eee; padding: 18px; margin-bottom: 15px; border-radius: 15px; background: white; }
        .status-badge { font-size: 10px; padding: 3px 8px; border-radius: 5px; font-weight: bold; display: inline-block; margin-top: 5px; }
        .eligible { background: #e8f5e9; color: #2e7d32; }
        .not-eligible { background: #ffebee; color: #c62828; }

        .admin-table { width: 100%; border-collapse: collapse; font-size: 11px; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
        .admin-table th { background: #f8f9fa; color: #7f8c8d; text-transform: uppercase; font-size: 10px; padding: 10px; }
        .admin-table td { border: 1px solid #f0f0f0; padding: 10px; text-align: left; }
        
        .pass-container { position: relative; width: 100%; margin-bottom: 15px; }
        .pass-container input { margin-bottom: 0; padding-right: 60px; }
        .show-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; color: #888; font-size: 11px; font-weight: bold; }
        .notif-item { background: #fff3cd; border-left: 5px solid var(--accent); padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
        .export-btn { font-size: 10px; background: var(--success); color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; }
        .emergency-btn { background: #e74c3c; color: white; border: none; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; margin-bottom: 20px; cursor: pointer; }
        
        .profile-pic-box { width: 60px; height: 60px; border-radius: 50%; background: #eee; overflow: hidden; border: 2px solid var(--brand); display: flex; align-items: center; justify-content: center; }
        .profile-pic-box img { width: 100%; height: 100%; object-fit: cover; }
        .edit-area { background: #f9f9f9; padding: 15px; border-radius: 15px; margin-top: 15px; border: 1px dashed #ccc; display: none; }

        @media print {
            body * { visibility: hidden; }
            #donationHistoryLog, #donationHistoryLog *, #hospitalLogs, #hospitalLogs * { visibility: visible; }
            #donationHistoryLog, #hospitalLogs { position: absolute; left: 0; top: 0; width: 100%; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="header">
        <div style="font-weight: 900; letter-spacing: 1.5px;">LIFELINK PRO</div>
        <div class="header-profile" id="headerProfileIcon" onclick="handleProfileClick()">
            <span id="defaultHeaderIcon">üë§</span>
            <img id="headerPfpImg" src="" style="display:none;">
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" id="btn-hosp" onclick="switchPane('hosp-pane')">HOSPITAL</div>
        <div class="nav-item" id="btn-reg" onclick="switchPane('reg-pane')">REGISTRATION</div>
    </div>

    <div id="hosp-pane" class="pane active">
        <h3>Hospital Blood Search</h3>
        <input type="text" id="hospName" placeholder="Enter Hospital Name (Required)">
        <select id="searchGroup">
            <option value="A+">A+</option><option value="B+">B+</option><option value="O+">O+</option><option value="AB+">AB+</option>
            <option value="A-">A-</option><option value="B-">B-</option><option value="O-">O-</option><option value="AB-">AB-</option>
        </select>
        <button class="btn" style="background:var(--brand)" onclick="performSearch()">Find Donors</button>
        <div id="searchResults" style="margin-top:20px"></div>
    </div>

    <div id="reg-pane" class="pane">
        <h3>Become a Donor</h3>
        <input type="text" id="regName" placeholder="Full Name">
        <div class="pass-container">
            <input type="password" id="regPass" placeholder="Password">
            <button class="show-btn" onclick="togglePass('regPass')">SHOW</button>
        </div>
        <input type="text" id="regAddress" placeholder="Full Address">
        <input type="tel" id="regPhone" placeholder="Phone Number">
        <select id="regGender">
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        <select id="regGroup">
            <option value="A+">A+</option><option value="B+">B+</option><option value="O+">O+</option><option value="AB+">AB+</option>
            <option value="A-">A-</option><option value="B-">B-</option><option value="O-">O-</option><option value="AB-">AB-</option>
        </select>
        <button class="btn" style="background:var(--success)" onclick="handleRegistration()">Create Account</button>
    </div>

    <div id="login-pane" class="pane">
        <h3>Sign In</h3>
        <input type="text" id="loginUser" placeholder="Username / Admin ID">
        <div class="pass-container">
            <input type="password" id="loginPass" placeholder="Password">
            <button class="show-btn" onclick="togglePass('loginPass')">SHOW</button>
        </div>
        <button class="btn" style="background:var(--dark)" onclick="handleLogin()">Login</button>
    </div>

    <div id="profile-pane" class="pane">
        <div id="profileHeader"></div>
        
        <div id="donor-view">
            <button onclick="toggleEditArea()" style="background: #f1f1f1; border: none; padding: 5px 10px; border-radius: 8px; font-size: 11px; cursor: pointer; color: #555; margin-bottom: 10px;">‚úèÔ∏è Edit Profile</button>

            <div id="editArea" class="edit-area">
                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                    <div class="profile-pic-box">
                        <img id="pfpDisplay" src="" style="display:none;">
                        <span id="pfpPlaceholder" style="font-size: 24px; color: #ccc;">üë§</span>
                    </div>
                    <div style="flex:1">
                        <label style="font-size: 10px; font-weight: bold; color: #666;">CHANGE PHOTO</label>
                        <input type="file" id="editPhoto" accept="image/*" style="font-size: 11px; padding: 5px; margin: 0; border: none;">
                    </div>
                </div>
                <input type="password" id="editPass" placeholder="Change Password (Optional)" style="padding: 10px; font-size: 12px;">
                <button class="btn" style="background: var(--dark); padding: 10px; font-size: 12px;" onclick="saveProfileChanges()">Save Changes</button>
            </div>

            <div style="background:var(--dark); color:white; padding:20px; border-radius:15px; text-align:center; margin-top: 15px;">
                <div style="font-size:12px; opacity:0.7">TOTAL DONATIONS</div>
                <div id="donationCount" style="font-size:32px; font-weight:bold">0</div>
                <button id="logBtn" class="btn" style="background:var(--accent); padding:8px; font-size:11px; margin-top:10px" onclick="logNewDonation()">LOG DONATION TODAY</button>
                <div id="cooldownTimer" style="font-size:10px; color:#ff7675; margin-top:5px"></div>
            </div>
            
            <h4 style="margin-top:25px; color:var(--dark)">üìã My Donation Activity</h4>
            <div id="donorDonationLogs"></div>

            <h4>Recent Alerts</h4>
            <div id="notificationsContainer"></div>
        </div>

        <div id="admin-view" style="display:none;">
            <button class="emergency-btn" onclick="emergencyBroadcast()">üö® EMERGENCY BROADCAST</button>
            <div class="stats-grid">
                <div class="stat-card">Total Donors<b id="totalDonors">0</b></div>
                <div class="stat-card">Hosp. Requests<b id="totalRequests">0</b></div>
            </div>
            <div class="chart-container">
                <div style="font-size:12px; font-weight:bold; color:var(--dark)">Stock Distribution</div>
                <div id="barGraph" class="bar-wrapper"></div>
            </div>
            <h4 style="color:var(--brand)">User Management</h4>
            <div id="adminListContainer"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px;">
                <h4 style="color:var(--success); margin: 0;">ü©∏ Global Donation History</h4>
                <button onclick="exportToPDF('donationHistoryLog')" class="export-btn">Download PDF</button>
            </div>
            <div id="donationHistoryLog"></div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 25px;">
                <h4 style="color:var(--dark); margin: 0;">üè• Hospital Request Logs</h4>
                <div>
                    <button onclick="exportToPDF('hospitalLogs')" class="export-btn">Download PDF</button>
                    <button onclick="clearRequestLogs()" style="font-size: 10px; color: red; border: 1px solid red; background: none; padding: 4px 8px; border-radius: 5px; cursor: pointer;">Clear</button>
                </div>
            </div>
            <div id="hospitalLogs"></div>
        </div>
        <button class="btn" style="background:#eee; color:#333; margin-top:30px" onclick="handleLogout()">Logout</button>
    </div>
</div>

<script>
    const ADMIN_PROFILES = [
        { id: "S.Durgaprasad", pwd: "prasad271" },
        { id: "U.pavankumar", pwd: "pavan310" },
        { id: "Sk.nagulshareef", pwd: "shareef277" }
    ];

    const COMPATIBILITY = {
        "A+": ["A+", "A-", "O+", "O-"], "B+": ["B+", "B-", "O+", "O-"],
        "AB+": ["A+", "A-", "B+", "B-", "O+", "O-", "AB+", "AB-"], "O+": ["O+", "O-"],
        "A-": ["A-", "O-"], "B-": ["B-", "O-"], "AB-": ["A-", "B-", "O-", "AB-"], "O-": ["O-"]
    };

    let storage = JSON.parse(localStorage.getItem('lifelink_global_v11')) || { donors: [], requests: [], activeSessionId: null };

    window.onload = function() { loadDashboard(); };
    function togglePass(id) {
        const x = document.getElementById(id);
        x.type = x.type === "password" ? "text" : "password";
        x.nextElementSibling.innerText = x.type === "password" ? "SHOW" : "HIDE";
    }
    function switchPane(id) {
        document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'profile-pane') loadDashboard();
    }
    function handleProfileClick() { storage.activeSessionId ? switchPane('profile-pane') : switchPane('login-pane'); }
    function saveData() { localStorage.setItem('lifelink_global_v11', JSON.stringify(storage)); }

    function toggleEditArea() {
        const area = document.getElementById('editArea');
        area.style.display = area.style.display === 'block' ? 'none' : 'block';
    }

    function saveProfileChanges() {
        const donorIndex = storage.donors.findIndex(d => d.id == storage.activeSessionId);
        if(donorIndex === -1) return;
        const newPass = document.getElementById('editPass').value;
        const photoFile = document.getElementById('editPhoto').files[0];
        if(newPass) storage.donors[donorIndex].pass = newPass;
        if(photoFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                storage.donors[donorIndex].pfp = e.target.result;
                saveData();
                document.getElementById('editArea').style.display = 'none';
                loadDashboard();
                alert("Profile Updated!");
            };
            reader.readAsDataURL(photoFile);
        } else {
            saveData();
            document.getElementById('editArea').style.display = 'none';
            loadDashboard();
            alert("Profile Updated!");
        }
    }

    function loadDashboard() {
        const admin = ADMIN_PROFILES.find(a => a.id === storage.activeSessionId);
        const donor = storage.donors.find(d => d.id == storage.activeSessionId);
        const hImg = document.getElementById('headerPfpImg');
        const hDef = document.getElementById('defaultHeaderIcon');
        hImg.style.display = "none";
        hDef.style.display = "block";

        if (admin) {
            document.getElementById('donor-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            document.getElementById('profileHeader').innerHTML = `<h3>Admin Mode</h3>`;
            renderAdminStats();
        } else if (donor) {
            document.getElementById('donor-view').style.display = 'block';
            document.getElementById('admin-view').style.display = 'none';
            if(donor.pfp) {
                hImg.src = donor.pfp;
                hImg.style.display = "block";
                hDef.style.display = "none";
                document.getElementById('pfpDisplay').src = donor.pfp;
                document.getElementById('pfpDisplay').style.display = "block";
                document.getElementById('pfpPlaceholder').style.display = "none";
            }
            document.getElementById('profileHeader').innerHTML = `
                <div style="margin-bottom:15px">
                    <h3 style="margin:0;">Welcome, ${donor.name}</h3>
                    <span style="color:var(--brand); font-weight:bold; font-size:14px;">Blood Group: ${donor.group}</span>
                </div>`;
            document.getElementById('donationCount').innerText = donor.history.length;
            const cooldown = getCooldownInfo(donor);
            const logBtn = document.getElementById('logBtn');
            const timerEl = document.getElementById('cooldownTimer');
            if(!cooldown.eligible) {
                logBtn.disabled = true;
                timerEl.innerText = `Eligible to donate in ${cooldown.daysLeft} days.`;
            } else { 
                logBtn.disabled = false; 
                timerEl.innerText = ""; 
            }
            renderDonorLogs(donor);
        }
    }

    function getCooldownInfo(donor) {
        if (!donor.history || donor.history.length === 0) return { eligible: true, daysLeft: 0 };
        const lastDate = new Date(donor.history[0].date);
        const diffDays = Math.floor(Math.abs(new Date() - lastDate) / (1000 * 60 * 60 * 24));
        const cooldownPeriod = (donor.gender === "Female") ? 120 : 90;
        return { eligible: diffDays >= cooldownPeriod, daysLeft: diffDays < cooldownPeriod ? cooldownPeriod - diffDays : 0 };
    }

    function performSearch() {
        const hospName = document.getElementById('hospName').value;
        const group = document.getElementById('searchGroup').value;
        if(!hospName) return alert("Hospital Name Required");
        const requestDate = new Date().toISOString().split('T')[0];
        storage.requests.unshift({ hospital: hospName, group: group, date: requestDate });
        saveData();
        const allowedGroups = COMPATIBILITY[group] || [group];
        const results = storage.donors.filter(d => allowedGroups.includes(d.group));
        const container = document.getElementById('searchResults');
        container.innerHTML = results.length ? `<p style="font-size:12px; color:var(--brand)">Compatible donors for ${group}</p>` : "No donors found.";

        results.forEach(d => {
            const cool = getCooldownInfo(d);
            const statusClass = cool.eligible ? 'eligible' : 'not-eligible';
            const statusText = cool.eligible ? '‚úÖ READY' : `‚è≥ WAIT (${cool.daysLeft}d)`;

            container.innerHTML += `
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong>${d.name} (${d.group})</strong><br>
                            <span class="status-badge ${statusClass}">${statusText}</span><br>
                            <small>Location: ${d.address}</small>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; color: var(--brand); font-size: 14px;">${d.phone}</div>
                            <a href="tel:${d.phone}"><button style="background: var(--dark); color: white; border: none; padding: 4px 10px; border-radius: 5px; font-size: 10px; cursor: pointer; margin-top: 5px;">üìû CALL</button></a>
                        </div>
                    </div>
                    <button class="btn" style="background:var(--success); padding:8px; font-size:11px; margin-top:12px" onclick="notifyDonor('${d.id}', '${hospName}', '${group}', '${requestDate}')">SEND ALERT</button>
                </div>`;
        });
    }

    function renderDonorLogs(donor) {
        let html = `<table class="admin-table"><tr><th>Date</th><th>Hospital</th></tr>`;
        donor.history.forEach(h => { html += `<tr><td>${h.date}</td><td>${h.hospital}</td></tr>`; });
        document.getElementById('donorDonationLogs').innerHTML = donor.history.length ? html + `</table>` : "<p style='font-size:11px'>No history.</p>";
        document.getElementById('notificationsContainer').innerHTML = donor.notifications.map(n => `<div class="notif-item">${n}</div>`).join('') || "No alerts.";
    }

    function handleLogin() {
        const user = document.getElementById('loginUser').value, pass = document.getElementById('loginPass').value;
        const admin = ADMIN_PROFILES.find(a => a.id === user && a.pwd === pass), donor = storage.donors.find(d => (d.name === user || d.phone === user) && d.pass === pass);
        if (admin || donor) { storage.activeSessionId = admin ? admin.id : donor.id; saveData(); switchPane('profile-pane'); } else { alert("Invalid Credentials."); }
    }

    function handleLogout() { storage.activeSessionId = null; saveData(); location.reload(); }
    function notifyDonor(donorId, hosp, group, date) {
        const donor = storage.donors.find(d => d.id == donorId);
        if(donor) { donor.notifications.unshift(`üöë URGENT: ${hosp} needs ${group} on ${date}`); saveData(); alert("Sent!"); }
    }
    function emergencyBroadcast() {
        const msg = prompt("Message:");
        if(msg) { storage.donors.forEach(d => d.notifications.unshift(`üì¢ ALERT: ${msg}`)); saveData(); alert("Sent!"); }
    }
    function handleRegistration() {
        const name = document.getElementById('regName').value, pass = document.getElementById('regPass').value, ph = document.getElementById('regPhone').value, grp = document.getElementById('regGroup').value, gen = document.getElementById('regGender').value;
        if(!name || !pass || !ph) return alert("Fill all details");
        storage.donors.push({ id: Date.now(), name, pass, address: document.getElementById('regAddress').value, phone: ph, group: grp, gender: gen, history: [], notifications: [], pfp: null });
        saveData(); alert("Registered!"); switchPane('login-pane');
    }
    function logNewDonation() {
        const donor = storage.donors.find(d => d.id == storage.activeSessionId);
        if(!donor) return;
        const hospitalName = prompt("Enter the hospital name (leave blank for Voluntary Donation):") || "Voluntary Donation";
        donor.history.unshift({ date: new Date().toISOString().split('T')[0], hospital: hospitalName });
        saveData(); loadDashboard(); alert("Logged!");
    }
    function renderAdminStats() {
        document.getElementById('totalDonors').innerText = storage.donors.length;
        document.getElementById('totalRequests').innerText = storage.requests.length;
        const counts = { "A+":0, "B+":0, "O+":0, "AB+":0, "A-":0, "B-":0, "O-":0, "AB-":0 };
        storage.donors.forEach(d => counts[d.group]++);
        let graphHtml = "";
        const maxVal = Math.max(...Object.values(counts)) || 1;
        for (let g in counts) {
            let height = (counts[g] / maxVal) * 90; 
            graphHtml += `<div><div class="bar" style="height:${height}px"><span>${counts[g]}</span></div><div class="bar-label">${g}</div></div>`;
        }
        document.getElementById('barGraph').innerHTML = graphHtml;
        let listHtml = `<table class="admin-table"><tr><th>Name</th><th>Group</th><th>Action</th></tr>`;
        storage.donors.forEach(d => { listHtml += `<tr><td>${d.name}</td><td><b>${d.group}</b></td><td><button onclick="deleteDonor(${d.id})" style="color:red; border:none; background:none;">Remove</button></td></tr>`; });
        document.getElementById('adminListContainer').innerHTML = listHtml + `</table>`;
        let historyHtml = `<table class="admin-table"><tr><th>Donor</th><th>Group</th><th>Date</th></tr>`;
        storage.donors.forEach(d => { d.history.forEach(h => { historyHtml += `<tr><td>${d.name}</td><td>${d.group}</td><td>${h.date}</td></tr>`; }); });
        document.getElementById('donationHistoryLog').innerHTML = historyHtml + `</table>`;
        let logHtml = `<table class="admin-table"><tr><th>Hospital</th><th>Group</th><th>Date</th></tr>`;
        storage.requests.forEach(r => { logHtml += `<tr><td>${r.hospital}</td><td>${r.group}</td><td>${r.date}</td></tr>`; });
        document.getElementById('hospitalLogs').innerHTML = logHtml + `</table>`;
    }
    function deleteDonor(id) { if(confirm("Delete?")) { storage.donors = storage.donors.filter(d => d.id != id); saveData(); renderAdminStats(); } }
    function clearRequestLogs() { if(confirm("Clear logs?")) { storage.requests = []; saveData(); renderAdminStats(); } }
    function exportToPDF(id) { window.print(); }
</script>
</body>
</html>
